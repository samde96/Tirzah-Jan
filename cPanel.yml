---
deployment:
  tasks:
    # Set deployment path to home directory where Node.js app will run
    - export DEPLOYPATH=/home/$CPANEL_USER/
    
    # Install dependencies
    - cd $DEPLOYPATH && npm ci
    
    # Generate Prisma client
    - cd $DEPLOYPATH && npm run prisma:generate || true
    
    # Build Express server and Next.js
    - cd $DEPLOYPATH && npm run server:build && npm run build
    
    # Prune production dependencies
    - cd $DEPLOYPATH && npm prune --production
    
    # Run Prisma migrations
    - cd $DEPLOYPATH && npx prisma migrate deploy || true
    
    # Restart PM2 application
    - pm2 restart tirzah-server || pm2 start npm --name tirzah-server -- run server:start
